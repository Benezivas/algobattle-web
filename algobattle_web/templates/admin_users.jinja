{% extends "base.jinja" %}
{% block content %}

<script src="/static/scripts/admin_users.js" type="module"></script>
<script>
  const users_input = {{users | tojson}}
  const teams_input = {{teams | tojson}}
  const contexts_input = {{contexts | tojson}}
</script>

<script type="text/x-template" id="table_row">
  <tr :class="{'table-primary': user.id == '{{user.id}}'}">
    <td>
      <div v-if="editing" class="input-group input-group-sm">
        <input class="form-control" name="name" type="text" v-model="user.name">
        <div class="input-group-append">
          <input type="checkbox" class="btn-check" id="set-admin" name="is_admin" v-model="user.is_admin">
          <label class="btn btn-outline-success btn-sm" for="set-admin" data-bs-toggle="tooltip" title="Admin"><i class="bi bi-patch-check"></i></label>
        </div>
      </div>
      <div v-else>
        <span>${user.name} </span>
        <i v-if="user.is_admin" class="bi bi-patch-check-fill text-success ms-1" data-bs-toggle="tooltip" data-bs-placement="right" title="Admin"></i>
      </div>
    </td>
    <td>
      <input v-if="editing" class="form-control form-control-sm" name="email" type="email" v-model="user.email">
      <span v-else>${user.email}</span>
    </td>
    <td><span>${teams_str}</span></td>
    <td class="text-end">
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-danger" data-bs-toggle="tooltip" title="Delete user" v-if="editing && user.id != '{{user.id}}'" @click="delete_user"><i class="bi bi-trash"></i></button>
        <button type="button" class="btn btn-warning" data-bs-toggle="tooltip" title="Edit user" @click="editing = !editing"><i class="bi bi-pencil"></i></button>
        <button type="button" class="btn btn-success" data-bs-toggle="tooltip" title="Submit edit" @click="edit_user" v-if="editing"><i class="bi bi-check2"></i></button>
      </div>
    </td>
  </tr>
</script>


<div class="col-8" id="app">
  <h3>Users</h3>
  <table class="table" id="users">
    <thead>
      <tr>
        <th scope="col">Name</th>
        <th scope="col">Email</th>
        <th scope="col">Teams</th>
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      <tr is="vue:table-row" v-for="user in store.users" :user="user" :key="user.id"></tr>
      <tr>
        <td>
          <div v-if="new_user.editing" class="input-group input-group-sm">
            <input class="form-control" name="name" type="text" v-model="new_user.name" required="required">
            <div class="input-group-append">
              <input type="checkbox" class="btn-check" id="set-admin" name="is_admin" v-model="new_user.is_admin">
              <label class="btn btn-outline-success btn-sm" for="set-admin" data-bs-toggle="tooltip" title="Admin"><i class="bi bi-patch-check"></i></label>
            </div>
          </div>
        </td>
        <td>
          <input v-if="new_user.editing" class="form-control form-control-sm" name="email" type="email" v-model="new_user.email" required="required">
        </td>
        <td></td>
        <td class="text-end">
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-warning" data-bs-toggle="tooltip" title="Add user" @click="new_user.editing = !new_user.editing"><i class="bi bi-plus-lg"></i></button>
            <button type="button" class="btn btn-success" data-bs-toggle="tooltip" title="Create" @click="create_user" v-if="new_user.editing"><i class="bi bi-check2"></i></button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="accordion w-xs" id="filtersAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="filterHeading">
        <button class="accordion-button" :class="{ collapsed: !has_params }" type="button" data-bs-toggle="collapse" data-bs-target="#filters" aria-expanded="false" aria-controls="filters">
          Filter
        </button>
      </h2>
      <div id="filters" class="accordion-collapse collapse p-3" :class="{ show: has_params }" aria-labelledby="filterHeading" data-bs-parent="#filtersAccordion">
        <label for="nameFilter" class="form-label">Name</label>
        <input class="form-control w-em" id="nameFilter" type="text" v-model="filter.name">
        <label for="emailFilter" class="form-label mt-3">Email</label>
        <input class="form-control w-em" id="emailFilter" type="text" v-model="filter.email">
        <label for="adminFilter" class="form-label mt-3">User type</label>
        <select class="form-select w-em" id="adminFilter" aria-label="User type filter" v-model="filter.is_admin">
          <option selected value="null">Any</option>
          <option value="true">Admin</option>
          <option value="false">Non Admin</option>
        </select>
        <label for="contextFilter" class="form-label mt-3">Context</label>
        <select class="form-select w-em" id="contextFilter" v-model="filter.context">
          <option :value="null"></option>
          <option v-for="(context, id) in store.contexts" :value="id">${context.name}</option>
        </select>
        <label for="teamFilter" class="form-label mt-3">Team</label>
        <select class="form-select w-em" id="teamFilter" v-model="filter.team">
          <option :value="null"></option>
          <option v-for="(team, id) in store.teams" :value="id">${team.name}</option>
        </select>
        <a class="btn btn-primary mt-3" :href="apply_filters" role="buttom">Apply</a>
      </div>
    </div>
  </div>
</div>


{% endblock %}
